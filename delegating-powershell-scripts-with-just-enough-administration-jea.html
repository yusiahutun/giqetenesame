<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=description content="Have you ever wanted to delegate a task, but found that the permissions needed can be too risky to hand out? Or, have you wanted to lock down things like group creation in AD to enforce naming conventions of groups?"><meta name=author content="Martina Birk"><meta name=generator content="Hugo 0.98.0"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><meta name=robots content="index,follow,noarchive"><link rel=stylesheet href=https://assets.cdnweb.info/hugo/base16/css/style.css type=text/css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Source+Code+Pro:400,700" type=text/css><link rel=alternate href=./index.xml type=application/rss+xml title=ZestD><title>Delegating PowerShell Scripts with Just Enough Administration (JEA) - ZestD</title></head><body><header><div class="container clearfix"><a class=path href=./index.html>[ZestD]</a>
<span class=caret># _</span><div class=right></div></div></header><div class=container><main role=main class=article><article class=single itemscope itemtype=http://schema.org/BlogPosting><div class=meta><span class=key>published on</span>
<span class=val><time itemprop=datePublished datetime=2024-08-13>August 13, 2024</time></span>
<span class=key>in</span>
<span class=val><a href=./categories/blog>blog</a></span></div><h1 class=headline itemprop=headline>Delegating PowerShell Scripts with Just Enough Administration (JEA)</h1><section class=body itemprop=articleBody><img src=https://cdn.statically.io/img/static1.howtogeekimages.com/wordpress/wp-content/uploads/csit/2020/03/23e4a5a4.png style=margin:auto;display:block;text-align:center;max-width:100%;height:auto><h3>Quick Links</h3><ul class=table-content-level-1><li><a href=#>What Is JEA?</a></li></ul><ul class=table-content-level-1><li><a href=#>Step 1: Creating a Function Out of Your Script</a></li></ul><ul class=table-content-level-1><li><a href=#>Step 2: Creating RoleCapabilities</a></li></ul><ul class=table-content-level-1><li><a href=#>Step 3: Creating a Module for the RoleCapability File</a></li></ul><ul class=table-content-level-1><li><a href=#>Step 4: Defining Roles</a></li></ul><ul class=table-content-level-1><li><a href=#>Step 5: Creating a PowerShell Session</a></li></ul><ul class=table-content-level-1><li><a href=#>Summary</a></li></ul><ul class=table-content-level-1><li><a href=#>Want to learn more?</a></li></ul><p>Have you ever wanted to delegate a task, but found that the permissions needed can be too risky to hand out? Or, have you wanted to lock down things like group creation in AD to enforce naming conventions of groups?</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><p>JEA can help you with just that and a lot more. In this article, we're going to walk through how you can delegate your already created scripts with PowerShell 5.1.</p><h2 id=what-is-jea>What Is JEA?</h2><p>JEA is a PowerShell solution from Microsoft that can restrict users (and administrators) to only be able to perform specified tasks in a specific PowerShell session, even if they require local admin on the said resource. In addition, you can be extremely specific. Only the commands you specify can be executed, you can enable only specific parameter values and parameter values that match a specific pattern.</p><p>For example, you can enable Servicedesk to only restart a specific service with</p><pre><code class=hljs>Restart-Service</code> </pre><p>, or only add groups to AD according to a specific naming convention. You can do all of this without giving them explicit permissions on a server or in AD. It's a tool that can save you a tremendous amount of time and secure your environment. Let's get started by wrapping our script into a function.</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><h2 id=step-1-creating-a-function-out-of-your-script>Step 1: Creating a Function Out of Your Script</h2><p>The first step if you've not already done so is to make a function out of your script. This is quite easy, assuming that you already have your</p><pre><code class=hljs>parameters</code> </pre><p>set up. Below, I've wrapped my simple script "New-FolderAndShare" into a function:</p><pre><code class="hljs xml"><span class=hljs-function><span class=hljs-keyword>Function</span>&nbsp;<span class=hljs-title>New</span>-<span class=hljs-title>FolderAndShare</span>&nbsp;</span>{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-selector-attr>[cmdletbinding()]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;param(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-comment># Name of the share</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-selector-attr>[parameter(Mandatory)]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-selector-attr>[ValidatePattern(<span class=hljs-string>"^(Project d{5}|Team (Finance|HR|IT|Multi) [a-z ]+)$"</span>)]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[string]$ShareName,<p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-comment># Directory of the new share folder locally</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-selector-attr>[parameter(Mandatory)]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-selector-attr>[ValidatePattern(<span class=hljs-string>"^(D|E|F):\Shares\$"</span>)]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[string]$Path,</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-comment># Who to have full access</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-selector-attr>[parameter(Mandatory)]</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ValidateSet("^CONTOSO\")]<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[string]$FullAccess</p><p>&nbsp;&nbsp;&nbsp;&nbsp;)</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$FullPath = Join-Path $Path $ShareName<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-keyword>New</span>-Item -ItemType Directory -Path $FullPath<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-keyword>New</span>-SmbShare -Path $FullPath -Name $ShareName -FullAccess $FullAccess</p><p>}</p></code> </pre><p>You validate the parameters with ValidatePattern in the function, but if this were a part of a module you could to that in the RoleCapabilities file instead with VisibleFunctions.</p><p>Making the script a function gives us greater control of what parameters are allowed in JEA, and makes it easier to export.</p><h2 id=step-2-creating-rolecapabilities>Step 2: Creating RoleCapabilities</h2><p>The RoleCapabilities file decides what a specified role (defined in the next step) is allowed to do. This includes what commands they are allowed to run, what parameters they can use, and what modules to import.</p><p>While RoleCapabilities can be created manually, it's recommended to use the <code>New-PSRoleCapabilityFile</code> command built into PowerShell 5.1. It's also in this file that you'll load in the function that we created in the previous step.</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><p>The follwing script creates a file called FileShareCreator.psrc and adds the <code>New-FolderAndShare</code> function (that needs to be loaded into the current session):</p><pre><code class="hljs xml"><span class=hljs-comment># RUN THIS IN THE SERVER THAT WILL BE THE JEA ENDPOINT</span><p>$RoleCapabilitiesParam = @{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-comment># Define a function that will be available in the cmdlet</span><br>&nbsp;&nbsp;&nbsp;&nbsp;FunctionDefinitions = @{ <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Name = <span class=hljs-string>'New-FolderAndShare'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-comment># Import the code of the function</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ScriptBlock = [ScriptBlock]::Create(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(Get-Command <span class=hljs-keyword>New</span>-FolderAndShare).Definition<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)<br>&nbsp;&nbsp;&nbsp;&nbsp;}</p><p>&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-comment># Modules used in the function needs to be explicity imported</span><br>&nbsp;&nbsp;&nbsp;&nbsp;ModulesToImport = @(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-string>"SmbShare"</span>,<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"<span class=hljs-selector-tag>Microsoft</span><span class=hljs-selector-class>.PowerShell</span><span class=hljs-selector-class>.Management</span>"<br>&nbsp;&nbsp;&nbsp;&nbsp;)<br>&nbsp;&nbsp;&nbsp;&nbsp;Path = <span class=hljs-string>".FileShareCreator.psrc"</span><br>}</p><p><span class=hljs-keyword>New</span>-PSRoleCapabilityFile @RoleCapabilitiesParam</p></code> </pre><p>Utilize <code>Get-Command</code> to fetch the function in the <code>FunctionDefinitions</code>-parameter. You can also add the raw script with parameters.</p><p>You also specify how you are allowed to use the function in the <code>VisibleCmdlet</code> parameter. You do this by specifying the name of the function and its parameters together with a regular expression.</p><p>With this, you can create an extremely granular control of what a user can and can't do. But there's one caveat to making this work---you need to add the psrc-file into a module.</p><h2 id=step-3-creating-a-module-for-the-rolecapability-file>Step 3: Creating a Module for the RoleCapability File</h2><p>It's time to create a module that you can put your role capabilities into. JEA finds the RoleCapabilities by the psrc files name without its extension, so avoid duplicates if you're going to create more role capabilities later on.</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><p>The following script is a modified version of what you find in the <a href=#>Official JEA documentation</a>. It creates a new module in the module directory, creates the necessary files and folders needed, and copies the psrc file that you created in Step 2 into it:</p><pre><code class="hljs xml"><span class=hljs-comment># RUN THIS IN THE SERVER THAT WILL BE THE JEA ENDPOINT</span><p><span class=hljs-comment># Create a folder for the module</span><br>$modulePath = Join-Path $env:ProgramFiles <span class=hljs-string>"WindowsPowerShellModulesFileShareJEA"</span><br><span class=hljs-keyword>New</span>-Item -ItemType Directory -Path $modulePath</p><p><span class=hljs-comment># Create an empty script module and module manifest.</span><br><span class=hljs-comment># At least one file in the module folder must have the same name as the folder itself.</span><br><span class=hljs-keyword>New</span>-Item -ItemType File -Path (Join-Path $modulePath <span class=hljs-string>"FileShareJEA.psm1"</span>)<br><span class=hljs-keyword>New</span>-ModuleManifest -Path (Join-Path $modulePath <span class=hljs-string>"FileShareJEA.psd1"</span>) -RootModule <span class=hljs-string>"FileShareJEA.psm1"</span></p><p><span class=hljs-comment># Create the RoleCapabilities folder and copy in the PSRC file</span><br>$rcFolder = Join-Path $modulePath <span class=hljs-string>"RoleCapabilities"</span><br><span class=hljs-keyword>New</span>-Item -ItemType Directory $rcFolder<br>Copy-Item -Path .FileShareCreator.psrc -Destination $rcFolder</p></code> </pre><p>You have now created a role capability and a function so that you can use it in JEA. What's left do now is to create a PowerShell Session Configuration to map AD groups to the roles you just created.</p><h2 id=step-4-defining-roles>Step 4: Defining Roles</h2><p>In this step, you're going to create a PowerShell Session Configuration file that defines what roles are going to be assigned what Capabilities (from the .psrc file we created in Step 2).</p><p>You're going to create the AD group and transcript directory here as well.</p><pre><code class="hljs xml"><span class=hljs-comment># Create directory to store logs</span><br><span class=hljs-keyword>New</span>-Item -ItemType Directory -Path <span class=hljs-string>'C:ProgramDataJEAConfigurationTranscripts'</span> -Force<p><span class=hljs-comment># Create AD group (you might need to do it on another server)</span><br><span class=hljs-keyword>New</span>-ADGroup -Path <span class=hljs-string>"OU=Groups,DC=contoso,DC=com"</span> -Name <span class=hljs-string>'JEA_FILESHARE_CREATOR'</span> -GroupScope DomainLocal</p><p><span class=hljs-comment># RUN THIS IN THE SERVER THAT WILL BE THE JEA ENDPOINT</span></p><p><span class=hljs-comment># Define parameters for New-PSSessionConfigurationFile</span><br>$PSSessionConfigurationParams = @{<br>&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-comment># Run as a temporary account</span><br>&nbsp;&nbsp;&nbsp;&nbsp;RunAsVirtualAccount = $True</p><p>&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-comment># That is a local administrator</span><br>&nbsp;&nbsp;&nbsp;&nbsp;RunAsVirtualAccountGroups = @(<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-string>"administrators"</span><br>&nbsp;&nbsp;&nbsp;&nbsp;)</p><p>&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-comment># Path where to save log files of what connected users are doing</span><br>&nbsp;&nbsp;&nbsp;&nbsp;TranscriptDirectory = <span class=hljs-string>'C:ProgramDataJEAConfigurationTranscripts'</span></p><p>&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-comment># Map an active directory group to the capability we created</span><br>&nbsp;&nbsp;&nbsp;&nbsp;RoleDefinitions = @{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-string>'CONTOSOJEA_FILESHARE_CREATOR'</span> = @{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RoleCapabilities = <span class=hljs-string>'FileShareCreator'</span><br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;}<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class=hljs-comment># Path of the PSSC file</span><br>&nbsp;&nbsp;&nbsp;&nbsp;Path = <span class=hljs-string>".SessionConfiguration.pssc"</span></p><p>}<br><span class=hljs-comment># Create the PSSC file</span><br><span class=hljs-keyword>New</span>-PSSessionConfigurationFile @PSSessionConfigurationParams</p></code> </pre><h2 id=step-5-creating-a-powershell-session>Step 5: Creating a PowerShell Session</h2><p>In this step, you will read in the SessionConfiguration.pssc file that you created in the previous step. This enables the members of JEA_FILESHARE_CREATOR to connect via PowerShell to the server:</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><pre><code class="hljs xml">PS51&gt; Register-PSSessionConfiguration -Path .SessionConfiguration.pssc -Name <span class=hljs-string>'JEAFileShare'</span> -Force<p><span class=hljs-selector-tag>PSPath</span> : <span class=hljs-selector-tag>Microsoft</span><span class=hljs-selector-class>.WSMan</span><span class=hljs-selector-class>.ManagementWSMan</span><span class=hljs-selector-pseudo>::localhostPluginJEAFileShare</span><br><span class=hljs-selector-tag>PSParentPath</span> : <span class=hljs-selector-tag>Microsoft</span><span class=hljs-selector-class>.WSMan</span><span class=hljs-selector-class>.ManagementWSMan</span><span class=hljs-selector-pseudo>::localhostPlugin</span><br>PSChildName : JEAFileShare<br>PSDrive : WSMan<br><span class=hljs-selector-tag>PSProvider</span> : <span class=hljs-selector-tag>Microsoft</span><span class=hljs-selector-class>.WSMan</span><span class=hljs-selector-class>.ManagementWSMan</span><br>PSIsContainer : <span class=hljs-keyword>True</span><br>Keys : {Name=JEAFileShare}<br>Name : JEAFileShare<br>TypeNameOfElement : Container<br>Type : Container</p></code> </pre><p>You're done! Add a user to JEA_FILESHARE_CREATOR that does not have access to the server through normal means and try it out as that user by typing:</p><pre><code class="hljs xml"><span class=hljs-selector-tag>PS51</span>&gt; <span class=hljs-selector-tag>Enter-PSSession</span>&nbsp;<span class=hljs-selector-tag>-ComputerName</span>&nbsp;<span class=hljs-selector-tag>fs02</span><span class=hljs-selector-class>.contoso</span><span class=hljs-selector-class>.com</span>&nbsp;<span class=hljs-selector-tag>-ConfigurationName</span>&nbsp;<span class=hljs-selector-tag>JEAFileShare</span><br>PS51&gt; <span class=hljs-keyword>New</span>-FolderAndShare -ShareName <span class=hljs-string>"Project 12345"</span> -Path D:Share</code> </pre><p>You can now run the command as a temporary local administrator that's locked down and only enabled to run a few default commands (visible with <code>Get-Command</code> while in session) and the <code>New-FolderAndShare</code> function that added in the Role Capabilities file.</p><p>If you want to see the account that's created temporarily, add <code>VisibleExternalCommands @('c:windowssystem32whoami.exe')</code> to your RoleCapabilities parameters in Step 2. You can run whoami and see the local administrator name:</p><pre><code class="hljs xml">PS51 &gt;whoami<br>winrm virtual userswinrm va_1_contoso_joe_helpdesk</code> </pre><h2 id=summary>Summary</h2><p>Using JEA can be an awesome and easy way to delegate out tasks and secure your environment. This does not only include your own scripts but built-in modules and installed modules as well. Even though JEA can be a great value-add, be careful! You can create a great risk to your environment if you delegate the wrong commands or specify the wrong parameters to unexpected individuals.</p><strong class="an-zone-tag-top ad-zone-advertising-tag"></strong> <strong class="an-zone-tag-bottom ad-zone-advertising-sub-tag"></strong><h2 id=want-to-learn-more>Want to learn more?</h2><ul><li><a href=#>Microsoft's Documentation on JEA</a></li><li><a href=# class="norewrite noskim" rel="sponsored nofollow">Getting started with Just Enough Administration (JEA) by Jason Helmick [YouTube]</a></li></ul><p class=postsid style=color:rgba(255,0,0,0)>ncG1vNJzZmivp6x7qbvWraagnZWge6S7zGibnq6fpcBwsMSlnKCZpJ67qHnPqK6eqqOdsq24jKyaq6GgqcBuw8itn2aipajBbrHNqKygoF2Wsa61zaKqraqRqbawuoyjnJpn</p></section></article></main></div><footer><div class=container><span class=copyright>&copy; 2024 ZestD - <a rel=license href=http://creativecommons.org/licenses/by/4.0/>CC BY 4.0</a></span></div></footer><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://js.zainuddin.my.id/floating.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://js.zainuddin.my.id/tracking_server_6.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="//analytics.cdnweb.info/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script></body></html>